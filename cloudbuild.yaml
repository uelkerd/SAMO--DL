steps:
  # Pull latest image for build caching (allow failure if image doesn't exist)
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker pull us-central1-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/emotion-detection-api:latest || exit 0

  # Build the Docker image with dynamic tag and caching
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '--cache-from', 'us-central1-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/emotion-detection-api:latest',
      '-f', 'deployment/docker/Dockerfile.optimized',
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/emotion-detection-api:$BUILD_ID',
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/emotion-detection-api:latest',
      '.'
    ]


  # Scan image for vulnerabilities
  - name: 'gcr.io/cloud-builders/gcloud'
    args: [
      'artifacts', 'docker', 'images', 'scan',
      'us-central1-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/emotion-detection-api:$BUILD_ID',
      '--region=us-central1'
    ]

  # Deploy to Cloud Run with parameterized configuration
  # IMPORTANT: secretEnv is only applied to this specific step. Other build steps
  # that need access to secrets would require their own secretEnv declarations.
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args: [
      'run', 'deploy', '${_SERVICE_NAME}',
      '--image', 'us-central1-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/emotion-detection-api:$BUILD_ID',
      '--region', '${_REGION}',
      '--platform', 'managed',
      '--allow-unauthenticated',
      '--port', '${_PORT}',
      '--memory', '${_MEMORY}',
      '--cpu', '${_CPU}',
      '--max-instances', '${_MAX_INSTANCES}'
    ]
    secretEnv: ['ADMIN_API_KEY']

# Available images
images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/emotion-detection-api:$BUILD_ID'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/emotion-detection-api:latest'

# Build options
options:
  machineType: '${_MACHINE_TYPE}'
  diskSizeGb: ${_DISK_SIZE}
  logging: CLOUD_LOGGING_ONLY

# Substitutions for all configurable values
substitutions:
  # Service configuration
  _SERVICE_NAME: 'emotion-detection-api'
  _REGION: 'us-central1'
  _PORT: '8080'

  # Resource allocation
  _MEMORY: '2Gi'
  _CPU: '2'
  _MAX_INSTANCES: '10'

  # Build configuration
  _MACHINE_TYPE: 'E2_HIGHCPU_8'
  _DISK_SIZE: 100

  # Artifact Registry configuration
  _ARTIFACT_REPO: 'samo-dl-repo'

# Available secrets (set these in Cloud Build settings)
# NOTE: These secrets are globally available but must be explicitly referenced
# in individual build steps using secretEnv to be accessible.
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/admin-api-key/versions/latest
      env: 'ADMIN_API_KEY'