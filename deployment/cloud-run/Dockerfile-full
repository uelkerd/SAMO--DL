# SAMO Cloud Run Dockerfile - Full Features (All 3 Core Features)
# Supports: Emotion Detection + Text Summarization + Voice Transcription

FROM python:3.11-slim

# Install system dependencies for audio processing
RUN apt-get update && apt-get install -y \
    ffmpeg=7:4.3.6-0+deb11u1 \
    libsndfile1=1.0.31-2 \
    libsox-fmt-all=14.4.2+git20190427-2+deb11u1 \
    sox=14.4.2+git20190427-2+deb11u1 \
    curl=7.74.0-1.3+deb11u7 \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements first for better Docker layer caching
COPY requirements-full.txt requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# Copy source code
COPY src/ ./src/
COPY deployment/cloud-run/secure_api_server.py ./
COPY deployment/cloud-run/*.py ./

# Environment variables for production
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV MODEL_CACHE_DIR=/app/models
ENV TORCH_HOME=/app/models/torch

# Create model cache directory
RUN mkdir -p /app/models/torch

# Expose port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Run the unified API server
CMD ["python", "-m", "src.unified_ai_api"]