<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hugging Face API Test - SAMO-DL</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a2e; color: white; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #333; border-radius: 8px; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        button { padding: 10px 20px; margin: 5px; background: #8b5cf6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #7c3aed; }
        #results { margin-top: 20px; }
        .api-response { background: #2a2a3e; padding: 15px; border-radius: 8px; margin: 10px 0; font-family: monospace; }
        input { padding: 10px; margin: 10px; width: 300px; background: #2a2a3e; color: white; border: 1px solid #555; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ü§ó Hugging Face API Test</h1>
    
    <div class="test-section">
        <h3>Step 1: Token Configuration</h3>
        <p>Your token is loaded from config.js. If you need to test with a different token, enter it below:</p>
        <div id="configStatus"></div>
        <input type="password" id="hfToken" placeholder="hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx (optional)">
        <button onclick="testHuggingFaceAPI()">Test API Connection</button>
        <div id="tokenTest"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 2: Generate Sample Text</h3>
        <p>Test the AI text generation with different prompts:</p>
        <button onclick="generateTestText('excitement')">Generate Excited Text</button>
        <button onclick="generateTestText('anxiety')">Generate Anxious Text</button>
        <button onclick="generateTestText('calm')">Generate Calm Text</button>
        <div id="generationTest"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 3: Update Demo Code</h3>
        <p>Once testing works, copy your token and update the demo:</p>
        <button onclick="showUpdateInstructions()">Show Update Instructions</button>
        <div id="updateInstructions"></div>
    </div>
    
    <div id="results"></div>

    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- Fallback config if external file fails -->
    <script>
        // Always ensure config exists
        console.log('üîß Initializing config...');
        
        if (typeof window.SAMO_CONFIG === 'undefined') {
            console.warn('‚ö†Ô∏è config.js not loaded, using fallback config');
            window.SAMO_CONFIG = {
                HUGGING_FACE: {
                    API_TOKEN: 'YOUR_HF_TOKEN_HERE',
                    MODEL: 'microsoft/DialoGPT-small',
                    MAX_LENGTH: 150,
                    TEMPERATURE: 0.8
                }
            };
        } else {
            console.log('‚úÖ config.js loaded successfully');
        }
        
        // Ensure HUGGING_FACE object exists
        if (!window.SAMO_CONFIG.HUGGING_FACE) {
            console.warn('‚ö†Ô∏è HUGGING_FACE config missing, creating...');
            window.SAMO_CONFIG.HUGGING_FACE = {
                API_TOKEN: 'YOUR_HF_TOKEN_HERE',
                MODEL: 'microsoft/DialoGPT-small',
                MAX_LENGTH: 150,
                TEMPERATURE: 0.8
            };
        }
        
        console.log('‚úÖ Config initialized:', window.SAMO_CONFIG);
    </script>
    
    <script>
        let hfToken = '';
        
        // Check config status on page load
        window.addEventListener('load', function() {
            // Add a small delay to ensure config is loaded
            setTimeout(checkConfigStatus, 100);
        });
        
        function checkConfigStatus() {
            const configStatus = document.getElementById('configStatus');
            
            console.log('üîç Checking config status...');
            console.log('window.SAMO_CONFIG:', window.SAMO_CONFIG);
            console.log('typeof window.SAMO_CONFIG:', typeof window.SAMO_CONFIG);
            
            // Force check if config exists
            if (typeof window.SAMO_CONFIG === 'undefined') {
                console.log('‚ùå SAMO_CONFIG is undefined, fallback should have loaded');
                configStatus.innerHTML = '<div class="error">‚ùå Config not loaded. Using fallback config.</div>';
                // Force load fallback
                window.SAMO_CONFIG = {
                    HUGGING_FACE: {
                        API_TOKEN: 'YOUR_HF_TOKEN_HERE',
                        MODEL: 'microsoft/DialoGPT-small',
                        MAX_LENGTH: 150,
                        TEMPERATURE: 0.8
                    }
                };
                hfToken = window.SAMO_CONFIG.HUGGING_FACE.API_TOKEN;
                configStatus.innerHTML = '<div class="success">‚úÖ Using fallback config! Token: ' + hfToken.substring(0, 10) + '...</div>';
                return;
            }
            
            if (window.SAMO_CONFIG && window.SAMO_CONFIG.HUGGING_FACE) {
                const token = window.SAMO_CONFIG.HUGGING_FACE.API_TOKEN;
                console.log('Token from config:', token);
                
                if (token && token !== 'YOUR_HF_TOKEN_HERE') {
                    configStatus.innerHTML = '<div class="success">‚úÖ Config loaded! Token: ' + token.substring(0, 10) + '...</div>';
                    hfToken = token; // Set global token
                    console.log('‚úÖ Token set successfully');
                } else {
                    configStatus.innerHTML = '<div class="warning">‚ö†Ô∏è Config loaded but token not set. Please update config.js or enter token below.</div>';
                    console.log('‚ö†Ô∏è Token not set in config');
                }
            } else {
                configStatus.innerHTML = '<div class="error">‚ùå Config not loaded. Check if config.js exists and is accessible.</div>';
                console.log('‚ùå SAMO_CONFIG not found');
            }
        }
        
        function testHuggingFaceModel(model, token) {
            console.log(`üß™ Testing model: ${model}`);
            
            fetch(`https://api-inference.huggingface.co/models/${model}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    inputs: "Today I'm feeling",
                    parameters: {
                        max_length: 50,
                        temperature: 0.8
                    }
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ HF API response:', data);
                
                let resultHTML = '<div class="api-response">';
                resultHTML += `<h4>API Response (${model}):</h4>`;
                resultHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                resultHTML += '</div>';
                
                if (data && data[0] && data[0].generated_text) {
                    resultHTML += '<div class="success">‚úÖ API CONNECTION SUCCESSFUL!</div>';
                    resultHTML += `<div class="success">üìù Generated: "${data[0].generated_text}"</div>`;
                } else {
                    resultHTML += '<div class="error">‚ùå No text generated</div>';
                }
                
                document.getElementById('tokenTest').innerHTML = resultHTML;
            })
            .catch(error => {
                console.error(`‚ùå HF API test failed for ${model}:`, error);
                
                // Try next model - use working models
                const models = ['microsoft/DialoGPT-small', 'microsoft/DialoGPT-medium', 'distilgpt2', 'gpt2'];
                const currentIndex = models.indexOf(model);
                
                if (currentIndex < models.length - 1) {
                    console.log(`üîÑ Trying next model: ${models[currentIndex + 1]}`);
                    testHuggingFaceModel(models[currentIndex + 1], token);
                } else {
                    document.getElementById('tokenTest').innerHTML = 
                        '<div class="error">‚ùå All models failed. Check your token or try again later.</div>';
                }
            });
        }
        
        function testHuggingFaceAPI() {
            // First try to get token from config
            let configToken = window.SAMO_CONFIG?.HUGGING_FACE?.API_TOKEN;
            
            // If config token is placeholder, try input field
            if (!configToken || configToken === 'YOUR_HF_TOKEN_HERE') {
                hfToken = document.getElementById('hfToken').value.trim();
                
                if (!hfToken) {
                    document.getElementById('tokenTest').innerHTML = '<div class="error">‚ùå Please enter your HF token first OR update config.js</div>';
                    return;
                }
                
                if (!hfToken.startsWith('hf_')) {
                    document.getElementById('tokenTest').innerHTML = '<div class="error">‚ùå Token should start with "hf_"</div>';
                    return;
                }
                
                // Update config with the token from input
                if (window.SAMO_CONFIG && window.SAMO_CONFIG.HUGGING_FACE) {
                    window.SAMO_CONFIG.HUGGING_FACE.API_TOKEN = hfToken;
                } else {
                    // Create config if it doesn't exist
                    window.SAMO_CONFIG = {
                        HUGGING_FACE: {
                            API_TOKEN: hfToken,
                            MODEL: 'microsoft/DialoGPT-small',
                            MAX_LENGTH: 150,
                            TEMPERATURE: 0.8
                        }
                    };
                }
            } else {
                hfToken = configToken;
                console.log('‚úÖ Using token from config.js');
            }
            
            console.log('üß™ Testing HF API with token:', hfToken.substring(0, 10) + '...');
            
            // Test with a simple prompt - try working models
            testHuggingFaceModel('microsoft/DialoGPT-small', hfToken);
        }
        
        function generateTestText(emotion) {
            if (!hfToken) {
                document.getElementById('generationTest').innerHTML = '<div class="error">‚ùå Please test your token first</div>';
                return;
            }
            
            const prompts = {
                'excitement': "Today I'm feeling incredibly excited and optimistic about",
                'anxiety': "I'm experiencing some anxiety and worry about",
                'calm': "I'm in such a peaceful and content state of mind because"
            };
            
            const prompt = prompts[emotion];
            
            document.getElementById('generationTest').innerHTML = '<div class="warning">üîÑ Generating text...</div>';
            
            fetch('https://api-inference.huggingface.co/models/microsoft/DialoGPT-small', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${hfToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    inputs: prompt,
                    parameters: {
                        max_length: 100,
                        temperature: 0.8,
                        do_sample: true,
                        top_p: 0.9
                    }
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Generated text:', data);
                
                let generatedText = data[0]?.generated_text || '';
                if (generatedText) {
                    // Clean up the text
                    generatedText = generatedText.replace(prompt, '').trim();
                    if (!generatedText.endsWith('.') && !generatedText.endsWith('!') && !generatedText.endsWith('?')) {
                        generatedText += '.';
                    }
                    generatedText = prompt + ' ' + generatedText;
                }
                
                let resultHTML = '<div class="api-response">';
                resultHTML += `<h4>Generated ${emotion} text:</h4>`;
                resultHTML += `<p style="font-size: 16px; line-height: 1.5; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">${generatedText}</p>`;
                resultHTML += '</div>';
                
                if (generatedText) {
                    resultHTML += '<div class="success">‚úÖ Text generated successfully!</div>';
                } else {
                    resultHTML += '<div class="error">‚ùå No text generated</div>';
                }
                
                document.getElementById('generationTest').innerHTML = resultHTML;
            })
            .catch(error => {
                console.error('‚ùå Text generation failed:', error);
                document.getElementById('generationTest').innerHTML = 
                    '<div class="error">‚ùå Generation failed: ' + error.message + '</div>';
            });
        }
        
        function showUpdateInstructions() {
            if (!hfToken) {
                document.getElementById('updateInstructions').innerHTML = '<div class="error">‚ùå Please test your token first</div>';
                return;
            }
            
            let instructions = '<div class="api-response">';
            instructions += '<h4>üîí SECURE Setup Instructions:</h4>';
            instructions += '<ol>';
            instructions += '<li>Open <code>website/config.js</code></li>';
            instructions += '<li>Find line 7: <code>API_TOKEN: \'YOUR_HF_TOKEN_HERE\',</code></li>';
            instructions += '<li>Replace <code>YOUR_HF_TOKEN_HERE</code> with your token:</li>';
            instructions += `<li><code>API_TOKEN: '${hfToken}',</code></li>`;
            instructions += '<li><strong>IMPORTANT:</strong> Add <code>config.js</code> to <code>.gitignore</code> to prevent committing tokens!</li>';
            instructions += '<li>Save the file and refresh the demo</li>';
            instructions += '</ol>';
            instructions += '<div class="success">‚úÖ Your token is ready to use securely!</div>';
            instructions += '<div class="warning">‚ö†Ô∏è Remember: Never commit real tokens to version control!</div>';
            instructions += '</div>';
            
            document.getElementById('updateInstructions').innerHTML = instructions;
        }
    </script>
</body>
</html>
